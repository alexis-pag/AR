<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Speaker-VR AR</title>
  <script src="./js/aframe.min.js"></script>
  <script src="./js/mindar-image-aframe.prod.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; }
    a-scene { width:100%; height:100%; display:block; }
  </style>
</head>
<body>
<a-scene mindar-image="imageTargetSrc: ./targets-2.mind;" embedded color-space="sRGB" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
  <a-camera mindar-image-camera></a-camera>
  <a-entity mindar-image-target="targetIndex: 0">
    <a-entity id="enceinte-parent" position="0 0 0" visible="false">
      <a-entity id="enceinte" scale="0.002 0.002 0.002">
        <a-entity id="back" obj-model="obj: ./assets/Back.obj" position="-20.15 4.75 -54.68" rotation="0 90 0" scale="1 1 1" material="color:#ffff80"></a-entity>
        <a-entity id="Left" obj-model="obj: ./assets/Left.obj" position="-31.10 62.19 -69.25" rotation="0 0 90" scale="1 1 1" material="color:#8080c0"></a-entity>
        <a-entity id="Right" obj-model="obj: ./assets/Right.obj" position="-89.76 21.66 21.74" rotation="0 0 -90" scale="1 1 1" material="color:#8000ff"></a-entity>
        <a-entity id="Batteries" obj-model="obj: ./assets/Batteries.obj" position="-78.81 35.71 9.96" rotation="-90 -88.58 0" scale="1 1 1" material="color:#80ffff"></a-entity>
        <a-entity id="Open" obj-model="obj: ./assets/Open.obj" position="-43.66 18.65 -44.25" rotation="0 90 0" scale="1 1 1" material="color:#ffff00"></a-entity>
        <a-entity id="Speaker" obj-model="obj: ./assets/Speaker.obj" position="-85.89 11.82 7.85" rotation="0 -90 0" scale="1 1 1" material="color:#ff8000"></a-entity>
        <a-entity id="Led" obj-model="obj: ./assets/led.obj" position="-59.97 77.85 -19.66" rotation="0 0 0" scale="1 1 1" material="color:#0080c0"></a-entity>
        <a-entity id="partie-avant" obj-model="obj: ./assets/partie-avant.obj" position="-107.78 29.12 -19.38" rotation="-90 90 0" scale="1 1 1" material="color:#ff0000"></a-entity>
        <a-entity id="bas" obj-model="obj: ./assets/bas.obj" position="-59.65 -18.20 -19.16" rotation="0 90 0" scale="1 1 1" material="color:#ff80c0"></a-entity>
      </a-entity>
    </a-entity>
  </a-entity>
</a-scene>

<script>
AFRAME.registerComponent('look-at-camera',{
  tick: function(){
    const camera = document.querySelector('a-camera');
    if(camera) this.el.object3D.lookAt(camera.object3D.position);
  }
});

document.addEventListener('DOMContentLoaded', ()=>{
  const parent = document.querySelector('#enceinte-parent');
  const enceinte = document.getElementById('enceinte');
  const components = [
    {id:'back',offset:{x:0,y:0,z:-200}},
    {id:'Left',offset:{x:-180,y:60,z:0}},
    {id:'Right',offset:{x:180,y:60,z:0}},
    {id:'Batteries',offset:{x:120,y:-70,z:80}},
    {id:'Open',offset:{x:-90,y:40,z:-130}},
    {id:'Speaker',offset:{x:-80,y:-30,z:200}},
    {id:'Led',offset:{x:0,y:180,z:0}},
    {id:'partie-avant',offset:{x:80,y:30,z:240}},
    {id:'bas',offset:{x:0,y:-130,z:0}}
  ];
  const originalData = {};
  const particles = [];
  let explosionSphere=null;

  const particlesContainer = document.createElement('a-entity');
  particlesContainer.setAttribute('id','particles-container');
  enceinte.appendChild(particlesContainer);

  function createParticles(){
    const colors=['#ffffff','#ffaa00','#ff6600','#ff0000'];
    explosionSphere = document.createElement('a-sphere');
    explosionSphere.setAttribute('radius',1);
    explosionSphere.setAttribute('color','#ffaa00');
    explosionSphere.setAttribute('material','shader: standard; color:#ffaa00; opacity:0; transparent:true; emissive:#ff6600');
    explosionSphere.setAttribute('visible',false);
    particlesContainer.appendChild(explosionSphere);
    for(let i=0;i<120;i++){
      const particle = document.createElement('a-box');
      const color = colors[Math.floor(Math.random()*colors.length)];
      particle.setAttribute('width',0.2);
      particle.setAttribute('height',0.2);
      particle.setAttribute('depth',0.2);
      particle.setAttribute('material',`shader: standard; color:${color}; opacity:0; transparent:true; emissive:${color}`);
      particle.setAttribute('visible',false);
      particlesContainer.appendChild(particle);
      particles.push(particle);
    }
  }

  function initComponents(){
    components.forEach(comp=>{
      const el=document.getElementById(comp.id);
      if(el){
        const pos=el.getAttribute('position');
        const rot=el.getAttribute('rotation');
        originalData[comp.id]={position:{x:pos.x,y:pos.y,z:pos.z}, rotation:{x:rot.x,y:rot.y,z:rot.z}};
      }
    });
  }

  function emitParticles(){
    if(explosionSphere){
      explosionSphere.setAttribute('visible',true);
      explosionSphere.setAttribute('animation__expand',{property:'radius',from:1,to:10,dur:600,easing:'easeOutQuad'});
      explosionSphere.setAttribute('animation__fade',{property:'material.opacity',from:1,to:0,dur:600,easing:'easeOutQuad'});
      setTimeout(()=>explosionSphere.setAttribute('visible',false),600);
    }
    particles.forEach((particle,i)=>{
      setTimeout(()=>{
        const angle=(i/particles.length)*Math.PI*2;
        const elevation=(Math.random()-0.5)*Math.PI*0.8;
        const radius=8+Math.random()*6;
        particle.setAttribute('visible',true);
        particle.setAttribute('position','0 0 0');
        const targetX=Math.cos(angle)*Math.cos(elevation)*radius;
        const targetY=Math.sin(elevation)*radius;
        const targetZ=Math.sin(angle)*Math.cos(elevation)*radius;
        particle.setAttribute('animation__move',{property:'position',to:`${targetX} ${targetY} ${targetZ}`,dur:1800,easing:'easeOutCubic'});
        particle.setAttribute('animation__spin',{property:'rotation',to:`${Math.random()*360} ${Math.random()*360} ${Math.random()*360}`,dur:1800,easing:'linear'});
        particle.setAttribute('animation__fade',{property:'material.opacity',from:1,to:0,dur:1800,delay:200,easing:'easeInQuad'});
        setTimeout(()=>particle.setAttribute('visible',false),2000);
      }, i*5);
    });
  }

  function explode(){
    emitParticles();
    components.forEach((comp,index)=>{
      const el=document.getElementById(comp.id);
      if(el){
        const orig = originalData[comp.id].position;
        const origRot = originalData[comp.id].rotation;
        const targetPos={x:orig.x+comp.offset.x,y:orig.y+comp.offset.y,z:orig.z+comp.offset.z};
        const targetRot={x:origRot.x+(Math.random()-0.5)*60,y:origRot.y+(Math.random()-0.5)*60,z:origRot.z+(Math.random()-0.5)*60};
        el.object3D.position.set(orig.x,orig.y,orig.z);
        el.object3D.rotation.set(THREE.MathUtils.degToRad(origRot.x),THREE.MathUtils.degToRad(origRot.y),THREE.MathUtils.degToRad(origRot.z));
        el.setAttribute('animation__pos',{property:'position',to:`${targetPos.x} ${targetPos.y} ${targetPos.z}`,dur:1800,easing:'easeOutCubic'});
        el.setAttribute('animation__rot',{property:'rotation',to:`${targetRot.x} ${targetRot.y} ${targetRot.z}`,dur:1800,easing:'easeOutCubic'});
      }
    });
  }

  function reassemble(){
    components.forEach((comp,index)=>{
      const el=document.getElementById(comp.id);
      if(el){
        const orig = originalData[comp.id].position;
        const origRot = originalData[comp.id].rotation;
        el.setAttribute('animation__return',{property:'position',to:`${orig.x} ${orig.y} ${orig.z}`,dur:1800,easing:'easeInOutCubic'});
        el.setAttribute('animation__rot_return',{property:'rotation',to:`${origRot.x} ${origRot.y} ${origRot.z}`,dur:1800,easing:'easeInOutCubic'});
      }
    });
  }

  function loopExplosion(){
    explode();
    setTimeout(()=>{
      reassemble();
      setTimeout(loopExplosion,3000); // pause avant la prochaine explosion
    },3000); // durée pendant laquelle les objets restent explosés
  }

  const targetEntity=document.querySelector('[mindar-image-target]');
  targetEntity.addEventListener('targetFound', ()=>{
    parent.setAttribute('visible',true);
    initComponents();
    createParticles();
    loopExplosion();
  });

  targetEntity.addEventListener('targetLost', ()=>{
    parent.setAttribute('visible',false);
  });
});
</script>
</body>
</html>
