<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Speaker-VR</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.5.4/dist/aframe-extras.min.js"></script>
  </head>
  <body>
    <a-scene>
      <!-- Camera -->
      <a-entity id="camera" camera wasd-controls look-controls position="0 1.6 3"></a-entity>
      
      <!-- Lights -->
      <a-entity light="type: ambient; intensity: 0.7; color: #ffffff"></a-entity>
      <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="3 5 2"></a-entity>
      <a-entity light="type: point; intensity: 0.5; color: #ffffff" position="0 2 0"></a-entity>
      
      <!-- Sky -->
      <a-sky color="#1a1a2e"></a-sky>
      
      <!-- OBJ Models avec rotation stable -->
      <a-entity id="enceinte-parent" position="0 0 -2" aframe-extras="look-at: 0 0 0; damping: 0.05">
        <a-entity id="enceinte" scale="0.01 0.01 0.01" rotation="0 0 0"
                  animation="property: rotation; to: 0 360 0; loop: true; dur: 5000; easing: linear">
          
          <a-entity id="back" obj-model="obj: ./assets/Back.obj" position="-20.15299 4.74877 -54.67917" rotation="0 90 0" material="color: #ffff80"></a-entity>
          <a-entity id="Left" obj-model="obj: ./assets/Left.obj" position="-31.10108 62.18591 -69.24553" rotation="0 0 90" material="color: #8080c0"></a-entity>
          <a-entity id="Right" obj-model="obj: ./assets/Right.obj" position="-89.76148 21.65531 21.74075" rotation="0 0 -90" material="color: #8000ff"></a-entity>
          <a-entity id="Batteries" obj-model="obj: ./assets/Batteries.obj" position="-78.80972 35.7123 9.96086" rotation="-89.99963750135457 -88.58271287399606 0" material="color: #80ffff"></a-entity>
          <a-entity id="Open" obj-model="obj: ./assets/Open.obj" position="-43.66647 18.64757 -44.24839" rotation="0 90 0" material="color: #ffff00"></a-entity>
          <a-entity id="Speaker" obj-model="obj: ./assets/Speaker.obj" position="-85.89407 11.82067 7.85191" rotation="0 -90 0" material="color: #ff8000"></a-entity>
          <a-entity id="Led" obj-model="obj: ./assets/led.obj" position="-59.96779 77.85118 -19.66102" material="color: #0080c0"></a-entity>
          <a-entity id="partie-avant" obj-model="obj: ./assets/partie-avant.obj" position="-107.78422 29.11701 -19.38373" rotation="-90 90 0" material="color: #ff0000"></a-entity> 
          <a-entity id="bas" obj-model="obj: ./assets/bas.obj" position="-59.65366 -18.19764 -19.1577" rotation="0 90 0" material="side: double; color: #ff80c0"></a-entity>
          
          <!-- Particules à l'intérieur de l'enceinte pour respecter l'échelle -->
          <a-entity id="particles-container" position="-60 20 -20"></a-entity>
        </a-entity>
      </a-entity>
      
      <!-- Instructions -->
      <a-text value="Déplacement: WASD | Regarder: Souris" position="-1.5 2.5 -3" color="#ffffff" width="3"></a-text>
    </a-scene>

    <script>
      // Composant pour faire suivre la caméra aux textes
      AFRAME.registerComponent('look-at-camera', {
        tick: function() {
          const camera = document.querySelector('#camera');
          if (camera) {
            this.el.object3D.lookAt(camera.object3D.position);
          }
        }
      });

      document.addEventListener('DOMContentLoaded', function() {
        const enceinte = document.getElementById('enceinte');
        const particlesContainer = document.getElementById('particles-container');
        
        const components = [
          {id: 'back', name: 'Face arrière', offset: {x: 0, y: 0, z: -200}},
          {id: 'Left', name: 'Côté gauche', offset: {x: -180, y: 60, z: 0}},
          {id: 'Right', name: 'Côté droit', offset: {x: 180, y: 60, z: 0}},
          {id: 'Batteries', name: 'Compartiment batteries', offset: {x: 120, y: -70, z: 80}},
          {id: 'Open', name: 'Bouton marche/arrêt', offset: {x: -90, y: 40, z: -130}},
          {id: 'Speaker', name: 'Haut-parleur principal', offset: {x: -80, y: -30, z: 200}},
          {id: 'Led', name: 'LED indicateur', offset: {x: 0, y: 180, z: 0}},
          {id: 'partie-avant', name: 'Face avant', offset: {x: 80, y: 30, z: 240}},
          {id: 'bas', name: 'Base de support', offset: {x: 0, y: -130, z: 0}}
        ];
        
        let isExploded = false;
        const originalData = {};
        const labels = {};
        const particles = [];
        let explosionSphere = null;
        
        function createParticles() {
          const colors = ['#ffffff', '#ffaa00', '#ff6600', '#ff0000'];
          explosionSphere = document.createElement('a-sphere');
          explosionSphere.setAttribute('radius', 10);
          explosionSphere.setAttribute('color', '#ffaa00');
          explosionSphere.setAttribute('material', 'opacity: 0; emissive: #ff6600; emissiveIntensity: 2; transparent: true');
          explosionSphere.setAttribute('visible', false);
          particlesContainer.appendChild(explosionSphere);
          
          for (let i = 0; i < 120; i++) {
            const particle = document.createElement('a-box');
            particle.setAttribute('width', 2);
            particle.setAttribute('height', 2);
            particle.setAttribute('depth', 2);
            particle.setAttribute('color', colors[Math.floor(Math.random() * colors.length)]);
            particle.setAttribute('material', 'opacity: 0; transparent: true; emissive: ' + colors[Math.floor(Math.random() * colors.length)] + '; emissiveIntensity: 0.5');
            particle.setAttribute('visible', false);
            particlesContainer.appendChild(particle);
            particles.push(particle);
          }
        }
        
        function init() {
          createParticles();
          
          components.forEach(comp => {
            const el = document.getElementById(comp.id);
            if (el) {
              const pos = el.getAttribute('position');
              const rot = el.getAttribute('rotation');
              originalData[comp.id] = { position: {x: pos.x, y: pos.y, z: pos.z}, rotation: {x: rot.x, y: rot.y, z: rot.z} };
              
              const label = document.createElement('a-entity');
              label.setAttribute('position', '0 35 0');
              label.setAttribute('visible', false);
              const text = document.createElement('a-text');
              text.setAttribute('value', comp.name);
              text.setAttribute('align', 'center');
              text.setAttribute('color', '#ffffff');
              text.setAttribute('width', 35);
              text.setAttribute('material', 'opacity: 0; transparent: true');
              text.setAttribute('look-at-camera', '');
              label.appendChild(text);
              el.appendChild(label);
              labels[comp.id] = {container: label, text: text};
            }
          });
          
          setTimeout(() => startCycle(), 5000);
        }
        
        function emitParticles() {
          if (explosionSphere) {
            explosionSphere.setAttribute('visible', true);
            explosionSphere.setAttribute('material', 'opacity: 1; emissive: #ff6600; emissiveIntensity: 3; transparent: true');
            explosionSphere.setAttribute('radius', 10);
            
            explosionSphere.setAttribute('animation__expand', { property: 'radius', from: 10, to: 100, dur: 600, easing: 'easeOutQuad' });
            explosionSphere.setAttribute('animation__fade', { property: 'material.opacity', from: 1, to: 0, dur: 600, easing: 'easeOutQuad' });
            setTimeout(() => { explosionSphere.setAttribute('visible', false); }, 600);
          }
          
          particles.forEach((particle, i) => {
            setTimeout(() => {
              const angle = (i / particles.length) * Math.PI * 2;
              const elevation = (Math.random() - 0.5) * Math.PI * 0.8;
              const radius = 80 + Math.random() * 60;
              
              particle.setAttribute('visible', true);
              particle.setAttribute('position', '0 0 0');
              particle.setAttribute('material', 'opacity: 1; transparent: true');
              
              const targetX = Math.cos(angle) * Math.cos(elevation) * radius;
              const targetY = Math.sin(elevation) * radius;
              const targetZ = Math.sin(angle) * Math.cos(elevation) * radius;
              
              particle.setAttribute('animation__move', { property: 'position', to: `${targetX} ${targetY} ${targetZ}`, dur: 1800, easing: 'easeOutCubic' });
              particle.setAttribute('animation__spin', { property: 'rotation', to: `${Math.random()*360} ${Math.random()*360} ${Math.random()*360}`, dur: 1800, easing: 'linear' });
              particle.setAttribute('animation__fade', { property: 'material.opacity', from: 1, to: 0, dur: 1800, delay: 200, easing: 'easeInQuad' });
              
              setTimeout(() => { particle.setAttribute('visible', false); }, 2000);
            }, i * 5);
          });
        }
        
        function explode() {
          isExploded = true;
          emitParticles();
          components.forEach((comp, index) => {
            const el = document.getElementById(comp.id);
            const label = labels[comp.id];
            if (el) {
              setTimeout(() => {
                el.removeAttribute('animation__pos'); el.removeAttribute('animation__rot');
                const orig = originalData[comp.id].position;
                const targetPos = { x: orig.x + comp.offset.x, y: orig.y + comp.offset.y, z: orig.z + comp.offset.z };
                const origRot = originalData[comp.id].rotation;
                const targetRot = { x: origRot.x + (Math.random()-0.5)*120, y: origRot.y + (Math.random()-0.5)*120, z: origRot.z + (Math.random()-0.5)*120 };
                el.setAttribute('animation__pos', { property: 'position', to: `${targetPos.x} ${targetPos.y} ${targetPos.z}`, dur: 1800, easing: 'easeOutCubic' });
                el.setAttribute('animation__rot', { property: 'rotation', to: `${targetRot.x} ${targetRot.y} ${targetRot.z}`, dur: 1800, easing: 'easeOutCubic' });
                if (label) { setTimeout(() => { label.container.setAttribute('visible', true); label.text.setAttribute('animation__show', { property: 'material.opacity', from:0, to:1, dur:600 }); },1000); }
              }, index*100);
            }
          });
        }
        
        function reassemble() {
          isExploded = false;
          components.forEach((comp, index) => {
            const el = document.getElementById(comp.id);
            const label = labels[comp.id];
            if (el) {
              if (label) { label.text.removeAttribute('animation__show'); label.text.setAttribute('animation__hide', { property:'material.opacity', from:1, to:0, dur:400 }); setTimeout(()=>{ label.container.setAttribute('visible', false); },400); }
              setTimeout(()=>{ el.removeAttribute('animation__pos'); el.removeAttribute('animation__rot'); const orig = originalData[comp.id].position; const origRot = originalData[comp.id].rotation; setTimeout(()=>{ el.setAttribute('animation__return',{ property:'position', to:`${orig.x} ${orig.y} ${orig.z}`, dur:1800, easing:'easeInOutCubic' }); el.setAttribute('animation__rot_return',{ property:'rotation', to:`${origRot.x} ${origRot.y} ${origRot.z}`, dur:1800, easing:'easeInOutCubic' }); },50); }, index*100);
            }
          });
        }
        
        function startCycle() {
          if (!isExploded) {
            explode();
            setTimeout(()=>{ reassemble(); setTimeout(()=>startCycle(),5000); },5000);
          }
        }
        
        const scene = document.querySelector('a-scene');
        if (scene.hasLoaded) { init(); } else { scene.addEventListener('loaded', init); }
      });
    </script>
  </body>
</html>
