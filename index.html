<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Speaker-VR AR</title>
  <script src="./js/aframe.min.js"></script>
  <script src="./js/mindar-image-aframe.prod.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
    }
    a-scene {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body>
  <a-scene mindar-image="imageTargetSrc: ./targets-2.mind; smooth: true; smoothCount: 10;" 
           embedded 
           color-space="sRGB" 
           vr-mode-ui="enabled: false" 
           device-orientation-permission-ui="enabled: false">

    <!-- Caméra AR -->
    <a-camera mindar-image-camera></a-camera>

    <!-- Cible AR -->
    <a-entity mindar-image-target="targetIndex: 0">

      <!-- Parent invisible par défaut, avec stabilisation -->
      <a-entity id="enceinte-parent" position="0 0 0" visible="false" stabilize>

        <!-- Objet enceinte avec positions originales -->
        <a-entity id="enceinte" scale="0.01 0.01 0.01">
          <a-entity id="back" obj-model="obj: ./assets/Back.obj" position="-20.15299 4.74877 -54.67917" rotation="0 90 0" scale="1 1 1" material="color: #ffff80"></a-entity>
          <a-entity id="Left" obj-model="obj: ./assets/Left.obj" position="-31.10108 62.18591 -69.24553" rotation="0 0 90" scale="1 1 1" material="color: #8080c0"></a-entity>
          <a-entity id="Right" obj-model="obj: ./assets/Right.obj" position="-89.76148 21.65531 21.74075" rotation="0 0 -90" scale="1 1 1" material="color: #8000ff"></a-entity>
          <a-entity id="Batteries" obj-model="obj: ./assets/Batteries.obj" position="-78.80972 35.7123 9.96086" rotation="-89.9996 -88.5827 0" scale="1 1 1" material="color: #80ffff"></a-entity>
          <a-entity id="Open" obj-model="obj: ./assets/Open.obj" position="-43.66647 18.64757 -44.24839" rotation="0 90 0" scale="1 1 1" material="color: #ffff00"></a-entity>
          <a-entity id="Speaker" obj-model="obj: ./assets/Speaker.obj" position="-85.89407 11.82067 7.85191" rotation="0 -90 0" scale="1 1 1" material="color: #ff8000"></a-entity>
          <a-entity id="Led" obj-model="obj: ./assets/led.obj" position="-59.96779 77.85118 -19.66102" rotation="0 0 0" scale="1 1 1" material="color: #0080c0"></a-entity>
          <a-entity id="partie-avant" obj-model="obj: ./assets/partie-avant.obj" position="-107.78422 29.11701 -19.38373" rotation="-90 90 0" scale="1 1 1" material="color: #ff0000"></a-entity>
          <a-entity id="bas" obj-model="obj: ./assets/bas.obj" position="-59.65366 -18.19764 -19.1577" rotation="0 90 0" scale="1 1 1" material="side: double; color: #ff80c0"></a-entity>
        </a-entity>

      </a-entity>
    </a-entity>
  </a-scene>

  <script>
    // Composant pour lisser les mouvements
    AFRAME.registerComponent('stabilize', {
      init: function () {
        this.previousPos = new THREE.Vector3();
      },
      tick: function () {
        const obj = this.el.object3D;
        this.previousPos.lerp(obj.position, 0.1); // facteur de lissage
        obj.position.copy(this.previousPos);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {

      const parent = document.querySelector('#enceinte-parent');

      const components = [
        {id:'back', offset:{x:0,y:0,z:-40}},
        {id:'Left', offset:{x:-30,y:20,z:-10}},
        {id:'Right', offset:{x:30,y:20,z:10}},
        {id:'Batteries', offset:{x:25,y:-20,z:15}},
        {id:'Open', offset:{x:-20,y:10,z:-25}},
        {id:'Speaker', offset:{x:-35,y:-10,z:35}},
        {id:'Led', offset:{x:0,y:35,z:5}},
        {id:'partie-avant', offset:{x:30,y:15,z:30}},
        {id:'bas', offset:{x:0,y:-30,z:-5}}
      ];

      const originalData = {};

      // Stocker positions et rotations d'origine
      components.forEach(comp => {
        const el = document.getElementById(comp.id);
        if(el){
          const pos = el.getAttribute('position');
          const rot = el.getAttribute('rotation');
          originalData[comp.id] = {
            x: pos.x, y: pos.y, z: pos.z,
            rx: rot.x, ry: rot.y, rz: rot.z
          };
        }
      });

      // Explosion fluide avec léger décalage et easing doux
      function explode() {
        components.forEach((comp, index) => {
          const el = document.getElementById(comp.id);
          if(el){
            const target = {
              x: originalData[comp.id].x + comp.offset.x,
              y: originalData[comp.id].y + comp.offset.y,
              z: originalData[comp.id].z + comp.offset.z
            };

            // Animation d'explosion avec rotation
            el.setAttribute('animation__explode', {
              property: 'position',
              to: `${target.x} ${target.y} ${target.z}`,
              dur: 2000,
              easing: 'easeOutElastic',
              delay: index * 80
            });

            // Rotation pendant l'explosion
            el.setAttribute('animation__rotate', {
              property: 'rotation',
              to: `${Math.random() * 360} ${Math.random() * 360} ${Math.random() * 360}`,
              dur: 2000,
              easing: 'easeOutQuad',
              delay: index * 80
            });

            // Retour en position avec rotation inverse
            setTimeout(() => {
              el.setAttribute('animation__return', {
                property: 'position',
                to: `${originalData[comp.id].x} ${originalData[comp.id].y} ${originalData[comp.id].z}`,
                dur: 2000,
                easing: 'easeInOutQuad'
              });

              const originalRotation = el.getAttribute('rotation');
              el.setAttribute('animation__rotateBack', {
                property: 'rotation',
                to: `${originalRotation.x} ${originalRotation.y} ${originalRotation.z}`,
                dur: 2000,
                easing: 'easeInOutQuad'
              });
            }, 3000 + index * 80);
          }
        });
      }

      // Détection de la cible AR
      const targetEntity = document.querySelector('[mindar-image-target]');
      targetEntity.addEventListener('targetFound', () => {
        parent.setAttribute('visible', true);
        setTimeout(() => explode(), 100); // léger délai pour stabiliser
      });

      targetEntity.addEventListener('targetLost', () => {
        parent.setAttribute('visible', false);
      });

    });
  </script>
</body>
</html>
