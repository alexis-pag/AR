<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
  </head>

  <body>
    <a-scene
      mindar-image="imageTargetSrc: ./targets-2.mind"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
    >
      <!-- CAMERA AR -->
      <a-camera></a-camera>

      <!-- TARGET -->
      <a-entity mindar-image-target="targetIndex: 0">

        <!-- CONTENEUR OBJ → invisible au départ -->
        <a-entity id="enceinte-group" visible="false" position="0 0 0" scale="0.001 0.001 0.001">

          <!-- TES OBJ AVEC LES POSITIONS EXACTES -->
          <a-entity id="back" obj-model="obj: ./assets/Back.obj"
            position="-20.15299 4.74877 -54.67917"
            rotation="0 90 0"
            material="color: #ffff80"></a-entity>

          <a-entity id="Left" obj-model="obj: ./assets/Left.obj"
            position="-31.10108 62.18591 -69.24553"
            rotation="0 0 90"
            material="color: #8080c0"></a-entity>

          <a-entity id="Right" obj-model="obj: ./assets/Right.obj"
            position="-89.76148 21.65531 21.74075"
            rotation="0 0 -90"
            material="color: #8000ff"></a-entity>

          <a-entity id="Batteries" obj-model="obj: ./assets/Batteries.obj"
            position="-78.80972 35.71230 9.96086"
            rotation="-89.9996 -88.5827 0"
            material="color: #80ffff"></a-entity>

          <a-entity id="Open" obj-model="obj: ./assets/Open.obj"
            position="-43.66647 18.64757 -44.24839"
            rotation="0 90 0"
            material="color: #ffff00"></a-entity>

          <a-entity id="Speaker" obj-model="obj: ./assets/Speaker.obj"
            position="-85.89407 11.82067 7.85191"
            rotation="0 -90 0"
            material="color: #ff8000"></a-entity>

          <a-entity id="Led" obj-model="obj: ./assets/led.obj"
            position="-59.96779 77.85118 -19.66102"
            rotation="0 0 0"
            material="color: #0080c0"></a-entity>

          <a-entity id="partie-avant" obj-model="obj: ./assets/partie-avant.obj"
            position="-107.78422 29.11701 -19.38373"
            rotation="-90 90 0"
            material="color: #ff0000"></a-entity>

          <a-entity id="bas" obj-model="obj: ./assets/bas.obj"
            position="-59.65366 -18.19764 -19.15770"
            rotation="0 90 0"
            material="color: #ff80c0"></a-entity>
        </a-entity>

      </a-entity>
    </a-scene>


    <!-- SCRIPT : EXPLOSION + REASSEMBLAGE -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const group = document.getElementById("enceinte-group");

        const parts = [
          "back", "Left", "Right", "Batteries", "Open", "Speaker",
          "Led", "partie-avant", "bas"
        ];

        const original = {};

        parts.forEach(id => {
          const el = document.getElementById(id);
          original[id] = {
            pos: el.getAttribute("position"),
            rot: el.getAttribute("rotation")
          };
        });

        function explode() {
          parts.forEach((id, i) => {
            const el = document.getElementById(id);
            const orig = original[id];

            const offset = {
              x: (Math.random() - 0.5) * 80,
              y: (Math.random() - 0.5) * 80,
              z: (Math.random() - 0.5) * 80
            };

            el.setAttribute("animation__explode", {
              property: "position",
              to: `${orig.pos.x + offset.x} ${orig.pos.y + offset.y} ${orig.pos.z + offset.z}`,
              dur: 1500,
              easing: "easeOutExpo"
            });
          });
        }

        function reassemble() {
          parts.forEach(id => {
            const el = document.getElementById(id);
            const orig = original[id];

            el.setAttribute("animation__rebuild", {
              property: "position",
              to: `${orig.pos.x} ${orig.pos.y} ${orig.pos.z}`,
              dur: 1500,
              easing: "easeInOutExpo"
            });
          });
        }

        const target = document.querySelector("[mindar-image-target]");
        target.addEventListener("targetFound", () => {
          group.setAttribute("visible", "true");

          setTimeout(explode, 600);
          setTimeout(reassemble, 3000);
        });

        target.addEventListener("targetLost", () => {
          group.setAttribute("visible", "false");
        });
      });
    </script>

  </body>
</html>
