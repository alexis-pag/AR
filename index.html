<script>
AFRAME.registerComponent('look-at-camera',{
  tick: function(){
    const camera=document.querySelector('a-camera');
    if(camera) this.el.object3D.lookAt(camera.object3D.position);
  }
});

document.addEventListener('DOMContentLoaded',()=>{
  const parent=document.querySelector('#enceinte-parent');
  const enceinte=document.getElementById('enceinte');

  const components=[
    {id:'back',offset:{x:0,y:0,z:-200}},
    {id:'Left',offset:{x:-180,y:60,z:0}},
    {id:'Right',offset:{x:180,y:60,z:0}},
    {id:'Batteries',offset:{x:120,y:-70,z:80}},
    {id:'Open',offset:{x:-90,y:40,z:-130}},
    {id:'Speaker',offset:{x:-80,y:-30,z:200}},
    {id:'Led',offset:{x:0,y:180,z:0}},
    {id:'partie-avant',offset:{x:80,y:30,z:240}},
    {id:'bas',offset:{x:0,y:-130,z:0}}
  ];

  const originalData={};
  const particles=[];
  let explosionSphere=null;
  let looping = false;

  const particlesContainer=document.createElement('a-entity');
  particlesContainer.setAttribute('id','particles-container');
  enceinte.appendChild(particlesContainer);

  function createParticles(){
    const colors=['#ffffff','#ffaa00','#ff6600','#ff0000'];
    explosionSphere=document.createElement('a-sphere');
    explosionSphere.setAttribute('radius',1);
    explosionSphere.setAttribute('color','#ffaa00');
    explosionSphere.setAttribute('material','shader:standard; color:#ffaa00; opacity:0; transparent:true; emissive:#ff6600');
    explosionSphere.setAttribute('visible',false);
    particlesContainer.appendChild(explosionSphere);

    for(let i=0;i<120;i++){
      const particle=document.createElement('a-box');
      const color=colors[Math.floor(Math.random()*colors.length)];
      particle.setAttribute('width',0.2);
      particle.setAttribute('height',0.2);
      particle.setAttribute('depth',0.2);
      particle.setAttribute('material',`shader:standard; color:${color}; opacity:0; transparent:true; emissive:${color}`);
      particle.setAttribute('visible',false);
      particlesContainer.appendChild(particle);
      particles.push(particle);
    }
  }

  function initComponents(){
    components.forEach(comp=>{
      const el=document.getElementById(comp.id);
      if(el){
        const pos=el.getAttribute('position');
        const rot=el.getAttribute('rotation');
        originalData[comp.id]={position:{x:pos.x,y:pos.y,z:pos.z},rotation:{x:rot.x,y:rot.y,z:rot.z}};
      }
    });
  }

  // --- Nouvelle fonction resetToOriginal ---
  function resetToOriginal(){
    components.forEach(comp=>{
      const el = document.getElementById(comp.id);
      const orig = originalData[comp.id].position;
      const origRot = originalData[comp.id].rotation;
      el.object3D.position.set(orig.x, orig.y, orig.z);
      el.object3D.rotation.set(
        THREE.MathUtils.degToRad(origRot.x),
        THREE.MathUtils.degToRad(origRot.y),
        THREE.MathUtils.degToRad(origRot.z)
      );
      // Supprime toutes les animations précédentes
      el.removeAttribute('animation__pos');
      el.removeAttribute('animation__rot');
      el.removeAttribute('animation__return');
      el.removeAttribute('animation__rot_return');
    });
  }

  function emitParticles(){
    if(explosionSphere){
      explosionSphere.setAttribute('visible',true);
      explosionSphere.setAttribute('animation__expand',{property:'radius',from:1,to:10,dur:600,easing:'easeOutQuad'});
      explosionSphere.setAttribute('animation__fade',{property:'material.opacity',from:1,to:0,dur:600,easing:'easeOutQuad'});
      setTimeout(()=>explosionSphere.setAttribute('visible',false),600);
    }
    particles.forEach((particle,i)=>{
      setTimeout(()=>{
        const angle=(i/particles.length)*Math.PI*2;
        const elevation=(Math.random()-0.5)*Math.PI*0.8;
        const radius=8+Math.random()*6;
        particle.setAttribute('visible',true);
        particle.setAttribute('position','0 0 0');
        const targetX=Math.cos(angle)*Math.cos(elevation)*radius;
        const targetY=Math.sin(elevation)*radius;
        const targetZ=Math.sin(angle)*Math.cos(elevation)*radius;
        particle.setAttribute('animation__move',{property:'position',to:`${targetX} ${targetY} ${targetZ}`,dur:1800,easing:'easeOutCubic'});
        particle.setAttribute('animation__spin',{property:'rotation',to:`${Math.random()*360} ${Math.random()*360} ${Math.random()*360}`,dur:1800,easing:'linear'});
        particle.setAttribute('animation__fade',{property:'material.opacity',from:1,to:0,dur:1800,delay:200,easing:'easeInQuad'});
        setTimeout(()=>particle.setAttribute('visible',false),2000);
      },i*5);
    });
  }

  function explode(){
    components.forEach(comp=>{
      const el=document.getElementById(comp.id);
      const orig = originalData[comp.id].position;
      const origRot = originalData[comp.id].rotation;
      const targetPos = {x:orig.x+comp.offset.x, y:orig.y+comp.offset.y, z:orig.z+comp.offset.z};
      const targetRot = {x:origRot.x+(Math.random()-0.5)*60,
                         y:origRot.y+(Math.random()-0.5)*60,
                         z:origRot.z+(Math.random()-0.5)*60};
      el.setAttribute('animation__pos',{property:'position',to:`${targetPos.x} ${targetPos.y} ${targetPos.z}`,dur:1800,easing:'easeOutCubic'});
      el.setAttribute('animation__rot',{property:'rotation',to:`${targetRot.x} ${targetRot.y} ${targetRot.z}`,dur:1800,easing:'easeOutCubic'});
    });
    emitParticles();
    setTimeout(reassemble, 1900);
  }

  function reassemble(){
    components.forEach(comp=>{
      const el=document.getElementById(comp.id);
      const orig = originalData[comp.id].position;
      const origRot = originalData[comp.id].rotation;
      el.setAttribute('animation__return',{property:'position',to:`${orig.x} ${orig.y} ${orig.z}`,dur:1800,easing:'easeInOutCubic'});
      el.setAttribute('animation__rot_return',{property:'rotation',to:`${origRot.x} ${origRot.y} ${origRot.z}`,dur:1800,easing:'easeInOutCubic'});
    });
    setTimeout(explode, 1900);
  }

  const targetEntity=document.querySelector('[mindar-image-target]');
  targetEntity.addEventListener('targetFound',()=>{
    parent.setAttribute('visible',true);
    initComponents();
    createParticles();
    looping = true;
    explode();
  });

  targetEntity.addEventListener('targetLost',()=>{
    parent.setAttribute('visible',false);
    looping = false;
    resetToOriginal(); // remet tout à l'état initial si le target disparaît
  });
});
</script>
