<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Speaker-VR AR</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
</head>
<body>
  <a-scene mindar-image="imageTargetSrc: ./targets-2.mind;"
           color-space="sRGB"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: false">

    <!-- Caméra AR qui affiche le flux vidéo -->
    <a-camera mindar-image-camera></a-camera>

    <!-- Target AR -->
    <a-entity mindar-image-target="targetIndex: 0">

      <!-- Parent invisible par défaut pour réduire le jitter -->
      <a-entity id="enceinte-parent" position="0 0 0" visible="false">

        <!-- Objet enceinte -->
        <a-entity id="enceinte" scale="0.01 0.01 0.01" rotation="0 0 0">

          <!-- OBJ Models -->
          <a-entity id="back" obj-model="obj: ./assets/Back.obj" position="-20.15299 4.74877 -54.67917" rotation="0 90 0" material="color: #ffff80"></a-entity>
          <a-entity id="Left" obj-model="obj: ./assets/Left.obj" position="-31.10108 62.18591 -69.24553" rotation="0 0 90" material="color: #8080c0"></a-entity>
          <a-entity id="Right" obj-model="obj: ./assets/Right.obj" position="-89.76148 21.65531 21.74075" rotation="0 0 -90" material="color: #8000ff"></a-entity>
          <a-entity id="Batteries" obj-model="obj: ./assets/Batteries.obj" position="-78.80972 35.7123 9.96086" rotation="-89.9996 -88.5827 0" material="color: #80ffff"></a-entity>
          <a-entity id="Open" obj-model="obj: ./assets/Open.obj" position="-43.66647 18.64757 -44.24839" rotation="0 90 0" material="color: #ffff00"></a-entity>
          <a-entity id="Speaker" obj-model="obj: ./assets/Speaker.obj" position="-85.89407 11.82067 7.85191" rotation="0 -90 0" material="color: #ff8000"></a-entity>
          <a-entity id="Led" obj-model="obj: ./assets/led.obj" position="-59.96779 77.85118 -19.66102" material="color: #0080c0"></a-entity>
          <a-entity id="partie-avant" obj-model="obj: ./assets/partie-avant.obj" position="-107.78422 29.11701 -19.38373" rotation="-90 90 0" material="color: #ff0000"></a-entity>
          <a-entity id="bas" obj-model="obj: ./assets/bas.obj" position="-59.65366 -18.19764 -19.1577" rotation="0 90 0" material="side: double; color: #ff80c0"></a-entity>

        </a-entity>
      </a-entity>
    </a-entity>

  </a-scene>

  <script>
    document.addEventListener('DOMContentLoaded', () => {

      const parent = document.querySelector('#enceinte-parent');

      const components = [
        {id:'back', offset:{x:0,y:0,z:-20}},
        {id:'Left', offset:{x:-15,y:10,z:0}},
        {id:'Right', offset:{x:15,y:10,z:0}},
        {id:'Batteries', offset:{x:10,y:-10,z:5}},
        {id:'Open', offset:{x:-10,y:5,z:-10}},
        {id:'Speaker', offset:{x:-15,y:-5,z:15}},
        {id:'Led', offset:{x:0,y:15,z:0}},
        {id:'partie-avant', offset:{x:10,y:5,z:15}},
        {id:'bas', offset:{x:0,y:-15,z:0}}
      ];

      const originalData = {};

      // Stocker les positions d'origine
      components.forEach(comp => {
        const el = document.getElementById(comp.id);
        if(el){
          const pos = el.getAttribute('position');
          originalData[comp.id] = {x: pos.x, y: pos.y, z: pos.z};
        }
      });

      // Explosion
      function explode() {
        components.forEach((comp, index) => {
          const el = document.getElementById(comp.id);
          if(el){
            const target = {
              x: originalData[comp.id].x + comp.offset.x,
              y: originalData[comp.id].y + comp.offset.y,
              z: originalData[comp.id].z + comp.offset.z
            };

            el.setAttribute('animation__explode', {
              property: 'position',
              to: `${target.x} ${target.y} ${target.z}`,
              dur: 1500,
              easing: 'easeOutCubic'
            });

            // Retour à la position initiale après 2s
            setTimeout(() => {
              el.setAttribute('animation__return', {
                property: 'position',
                to: `${originalData[comp.id].x} ${originalData[comp.id].y} ${originalData[comp.id].z}`,
                dur: 1500,
                easing: 'easeInCubic'
              });
            }, 2000);
          }
        });
      }

      // Détecter cible AR
      const targetEntity = document.querySelector('[mindar-image-target]');
      targetEntity.addEventListener('targetFound', () => {
        parent.setAttribute('visible', true);
        explode();
      });

      targetEntity.addEventListener('targetLost', () => {
        parent.setAttribute('visible', false);
      });

    });
  </script>
</body>
</html>
